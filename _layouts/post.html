<!DOCTYPE html>
<html lang="{{ site.locale | slice: 0,2 | default: "en" }}">

  {% include head.html %}

  <body id="page-top" class="body-light-background">

    {% include navigation.html %}

    <article class="post-content page-section">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-10">

            <header class="post-header text-center">
              <h1 class="post-title">{{ page.title }}</h1>
              <p class="post-meta section-subheading text-muted">
                {{ page.date | date: "%B %d, %Y" }}
                {% if page.author %}
                  by {{ page.author }}
                {% endif %}
                {% if page.categories %}
                  in
                  {% for category in page.categories %}
                    {{ category }}{% unless forloop.last %},
                    {% endunless %}
                  {% endfor %}
                {% endif %}
              </p>
            </header>

            {% if page.header.teaser %}
              {% assign teaser_src = page.header.teaser | relative_url %}
              {% assign teaser_base = teaser_src | split: "." | first %}

              <div class="post-image-container mt-4 mb-4 text-center">
                <picture>
                  {% assign avif_path = teaser_base | append: ".avif" %}
                  {% assign avif_file = site.static_files | where: "path", avif_path | first %}
                  {% if avif_file %}
                    <source srcset="{{ avif_path | relative_url }}" type="image/avif">
                  {% endif %}

                  {% assign webp_path = teaser_base | append: ".webp" %}
                  {% assign webp_file = site.static_files | where: "path", webp_path | first %}
                  {% if webp_file %}
                    <source srcset="{{ webp_path | relative_url }}" type="image/webp">
                  {% endif %}

                  <img
                    src="{{ teaser_src }}"
                    alt="{{ page.title }} Teaser Image"
                    class="img-fluid rounded"
                    loading="lazy">
                </picture>
              </div>
            {% endif %}

            <div class="post-body text-muted">
              {{ content }}
            </div>

            {% assign maria = site.data.sitetext.team.people | where: "name", "Maria O'Farrell" | first %}
            {% if maria and site.data.sitetext.team.short_bio %}
              <div class="about-author-section p-3 mt-5 border rounded bg-light">
                <h6 class="section-subheading text-center">About the Author</h6>
                <div class="row align-items-center">
                  <div class="col-auto">
                    <img
                      src="{{ maria.image | relative_url }}"
                      alt="{{ maria.name }}"
                      class="rounded-circle"
                      style="width: 80px; height: 80px; object-fit: cover;">
                  </div>
                  <div class="col">
                    <div class="text-muted small">
                      {{ site.data.sitetext.team.short_bio | markdownify }}
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}


            <hr class="mt-5 mb-5">
            <div class="related-posts mb-5">
              <h3 class="text-center mb-4">Related Posts
            </h3>


              {% comment %} Prepare downcased concepts for the current page. Ensure page.concepts is not nil. {% endcomment %}
              {% assign current_page_concepts_downcased = "" | split: "" %}
              {% if page.concepts %}
                {% for concept_string in page.concepts %}
                  {% assign downcased_concept_string = concept_string | downcase %}
                  {% assign current_page_concepts_downcased = current_page_concepts_downcased | push: downcased_concept_string %}
                {% endfor %}
              {% endif %}


              {% assign current_post_url = page.url %}
              {% assign related_posts_found = 0 %}
              {% assign max_related_posts = 3 %}

              <div class="row">
                {% for post in site.posts %}
                  {% if related_posts_found >= max_related_posts %}
                    {% break %}
                  {% endif %}

                  {% if post.url == current_post_url %}
                    {% continue %}
                {% endif %}


                  {% comment %} Prepare downcased concepts for the other post. Ensure post.concepts is not nil. {% endcomment %}
                  {% assign other_post_concepts_downcased = "" | split: "" %}
                  {% if post.concepts %}
                    {% for concept_string in post.concepts %}
                      {% assign downcased_concept_string = concept_string | downcase %}
                      {% assign other_post_concepts_downcased = other_post_concepts_downcased | push: downcased_concept_string %}
                    {% endfor %}
                  {% endif %}

                  {% assign common_concepts_count = 0 %}
                  {% assign temp_common_concepts_array_debug = "" | split: "" %}

                  {% if current_page_concepts_downcased.size > 0 and other_post_concepts_downcased.size > 0 %}
                    {% for current_concept_item in current_page_concepts_downcased %}
                      {% if other_post_concepts_downcased contains current_concept_item %}
                        {% assign common_concepts_count = common_concepts_count | plus: 1 %}
                        {% assign temp_common_concepts_array_debug = temp_common_concepts_array_debug | push: current_concept_item %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                  {% if common_concepts_count > 0 %}
                    <div class="col-md-6 col-lg-4 mb-4">
                      <div class="blog-card h-100">
                        {% if post.header.teaser %}
                          <a href="{{ post.url | relative_url }}">
                            {% assign related_teaser_src = post.header.teaser | relative_url %}
                            {% assign related_teaser_base = related_teaser_src | split: "." | first %}
                            <picture>
                              {% assign related_avif_path = related_teaser_base | append: ".avif" %}
                              {% assign related_avif_file = site.static_files | where: "path", related_avif_path | first %}
                              {% if related_avif_file %}
                                <source srcset="{{ related_avif_path | relative_url }}" type="image/avif">
                              {% endif %}

                              {% assign related_webp_path = related_teaser_base | append: ".webp" %}
                              {% assign related_webp_file = site.static_files | where: "path", related_webp_path | first %}
                              {% if related_webp_file %}
                                <source srcset="{{ related_webp_path | relative_url }}" type="image/webp">
                              {% endif %}
                              <img
                                src="{{ related_teaser_src }}"
                                alt="{{ post.title }} Teaser"
                                class="blog-card-img"
                                loading="lazy">
                            </picture>
                          </a>
                        {% endif %}
                        <div class="blog-card-content">
                          <h5 class="blog-card-title">
                            <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
                          </h5>
                          <p class="blog-card-excerpt">{{ post.excerpt | strip_html | truncatewords: 20 }}</p>
                          <p class="blog-card-meta">
                            <small>{{ post.date | date: "%B %d, %Y" }}</small>
                          </p>
                        </div>
                      </div>
                    </div>
                    {% assign related_posts_found = related_posts_found | plus: 1 %}
                  {% endif %}
                {% endfor %}
              </div>

              {% if related_posts_found == 0 %}
                <p class="text-center text-muted">No related posts found.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </article>

    {% include footer.html %}

    <script src="{{ 'assets/js/jquery.min.js' | relative_url }}" defer></script>
    <script src="{{ 'assets/js/bootstrap.bundle.min.js' | relative_url }}" defer></script>
    <script src="{{ 'assets/js/jquery.easing.min.js' | relative_url }}" defer></script>
    <script src="{{ 'assets/js/jqBootstrapValidation.js' | relative_url }}" defer></script>
    <script src="{{ 'assets/js/contact_me.js' | relative_url }}" defer></script>
    <script src="{{ 'assets/js/agency.min.js' | relative_url }}" defer></script>
    {% if site.data.style.search_engine_js %}
      <script src="{{ site.data.style.search_engine_js | relative_url }}" defer></script>
    {% endif %}
  </body>
</html>